<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mare's Cakes & Pastries — Order Online</title>
  <meta name="description" content="Order banana bread, cake loaves and more from Mare's Cakes & Pastries. Secure Paystack payment; WhatsApp order link appears after payment."/>
  <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=i_qE_hJrvvbk-rcLw4ejltuTO6vm_l88mncM5gFi8ZOnqjfC-3navBlflmBL7bXXhKxTcf0epuC5jTtcGYqfzRZA4ayAOGX4m6zwchgNyZ_pNp7oy8pRd4Ow_X9-bdVva0kW1Ofu8XOlO2E9jEyIjIWD2ZhgHWAczVkbb8rAk6AdNiP70JJL7puR6iqUNbuGaWOgtDHYESdS-4j7YJmjuFYvZINOZZz0JFz5sGJvS250Wo_qTY05vNG25Hk38etz" charset="UTF-8"></script><script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="icon" href="https://res.cloudinary.com/dvl40rhin/image/upload/v1759081580/MARE_LOGO_ONLY_sjojzh.png"/>
  <style>
    :root{
      --brand-primary:#5f1d2d;  /* wine */
      --brand-accent:#ffb703;   /* butter */
      --brand-bg:#fffaf5;
    }
    .fade-in { animation: fade 0.2s ease-in; }
    @keyframes fade { from{opacity:0} to{opacity:1} }
  </style>
</head>
<body class="bg-[var(--brand-bg)] text-zinc-800">
  <div id="root"></div>
  <noscript><div style="padding:16px;background:#fff3cd;color:#7a5b00">This site requires JavaScript to run.</div></noscript>

  <script type="text/babel" data-presets="react,env">
    const { useState, useMemo, useEffect } = React;

    // ===== CONFIG =====
    const BRAND = { name: "Mare's Cakes & Pastries", short: "Mare's", color: "var(--brand-primary)" };
    const PAYMENT = { paystackPublicKey: "pk_live_e6cab8c613057e6cc0c0a5f1c09d24b34fc01b34" };
    const BUSINESS = { whatsappPhone: "2349065307788" };
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbwuNDLgTA1vWNZResox1KW88B1YZ_ksbd-P8Oki01y0tDnxXpriIFIXA2D5YFjTk4DR/exec";

    const VAT_RATE = 0.075; // 7.5%
    const N = (n)=> `₦${(n??0).toLocaleString("en-NG")}`;
    const SIZES = ["Mini","Medium","Regular"];
    const DEBUG = /[?&]debug=1/.test(location.search);

    // ===== MENU =====
    const ITEMS = [
      {id:"bb_classic", group:"Banana Bread", name:"Classic Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759079789/Classic_Banana_Bread_apwoe3.jpg", variants:{ Mini:1500, Medium:5500, Regular:8000 }},
      {id:"bb_raisins", group:"Banana Bread", name:"Raisins Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759079885/Raisins_Banana_Bread_y8dyxt.jpg", variants:{ Mini:1700, Medium:6000, Regular:8800 }},
      {id:"bb_choco", group:"Banana Bread", name:"Chocolate Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759079973/chocolate_banana_bread_ybedbi.jpg", variants:{ Mini:1700, Medium:5000, Regular:8400 }},
      {id:"bb_nutty", group:"Banana Bread", name:"Nutty Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080017/Nutty_Banana_Bread_xe61cb.jpg", variants:{ Mini:2400, Medium:7600, Regular:10300 }},
      {id:"bb_classic_ganache", group:"Banana Bread", name:"Classic × Ganache Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080095/Classic_Ganache_Banana_Bread_mhgqqq.jpg", variants:{ Mini:1700, Medium:6000, Regular:8800 }},
      {id:"bb_choc_chips", group:"Banana Bread", name:"Chocolate Chips Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080154/Chocolate_Chips_Banana_Bread_begokb.jpg", variants:{ Mini:1700, Medium:6000, Regular:8400 }},
      {id:"bb_coconut", group:"Banana Bread", name:"Coconut Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080217/Coconut_Banana_Bread_vjop89.jpg", variants:{ Mini:1800, Medium:6200, Regular:9000 }},
      {id:"bb_oreo_choc", group:"Banana Bread", name:"Oreo × Chocolate Chips Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080265/Oreo_Chocolate_Chips_Banana_Bread_u4b0fq.jpg", variants:{ Mini:2300, Medium:7500, Regular:8000 }},
      {id:"bb_oreo_delight", group:"Banana Bread", name:"Oreo Delight Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080328/Oreo_Delight_Banana_Bread_d3sa3n.jpg", variants:{ Mini:2000, Medium:6500, Regular:9000 }},
      {id:"bb_baileys", group:"Banana Bread", name:"Baileys Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080402/Baileys_Banana_Bread_eqdbsw.jpg", variants:{ Mini:1900, Medium:6600, Regular:9000 }},
      {id:"bb_baileys_coco", group:"Banana Bread", name:"Baileys × Coconut Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080449/Baileys_Coconut_Banana_Bread_pa0xoz.jpg", variants:{ Mini:2500, Medium:8000, Regular:10500 }},
      {id:"bb_coco_choc_chips", group:"Banana Bread", name:"Coconut × Chocolate Chips Banana Bread", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080449/Baileys_Coconut_Banana_Bread_pa0xoz.jpg", variants:{ Mini:1900, Medium:6200, Regular:8400 }},
      {id:"cl_choc", group:"Cake Loaf", name:"Chocolate Cake Loaf", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080618/Chocolate_Cake_Loaf_gl8vbi.jpg", variants:{ Mini:2000, Medium:4800, Regular:8200 }},
      {id:"cl_redvelvet", group:"Cake Loaf", name:"Red Velvet Cake Loaf", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080697/Red_Velvet_Cake_Loaf_aripvz.jpg", variants:{ Mini:2200, Medium:5000, Regular:8500 }},
      {id:"cl_darkchoc", group:"Cake Loaf", name:"Dark Chocolate Cake Loaf", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080759/Dark_Chocolate_Cake_Loaf_wt5o85.jpg", variants:{ Mini:2400, Medium:5500, Regular:9000 }},
      {id:"cl_carrot", group:"Cake Loaf", name:"Carrot Cake Loaf", img:"https://res.cloudinary.com/dvl40rhin/image/upload/v1759080848/Carrot_Cake_Loaf_rovgf7.jpg", variants:{ Mini:null, Medium:5500, Regular:8400 }},
    ];

    // ===== UI PRIMITIVES =====
    const Section = ({ title, children, right }) => (
      <section className="bg-white border border-zinc-200 rounded-2xl shadow-sm p-5 md:p-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg md:text-xl font-semibold">{title}</h2>
          {right}
        </div>
        {children}
      </section>
    );

    const Qty = ({ value, onChange, min = 0 }) => (
      <div className="inline-flex items-center rounded-xl border border-zinc-300 overflow-hidden">
        <button className="px-3 py-1.5 hover:bg-zinc-50" onClick={() => onChange(Math.max(min, (value || 0) - 1))}>−</button>
        <input className="w-14 text-center py-1.5 outline-none" type="number" min={min} value={value || 0} onChange={(e) => onChange(Math.max(min, Number(e.target.value)))} />
        <button className="px-3 py-1.5 hover:bg-zinc-50" onClick={() => onChange((value || 0) + 1)}>＋</button>
      </div>
    );

    function useCart(){
      const [cart, setCart] = useState({});
      const setQty = (key, entry) => {
        setCart((c)=>{
          const copy = {...c};
          if (!entry || (entry.qty||0) <= 0) delete copy[key]; else copy[key] = entry;
          return copy;
        });
      };
      return { cart, setQty, setCart };
    }

    // ===== PAYSTACK LOADER (robust) =====
    let __paystackScriptLoading;
    function ensurePaystack(){
      if (typeof window !== 'undefined' && window.PaystackPop) return Promise.resolve('already');
      if (__paystackScriptLoading) return __paystackScriptLoading;
      __paystackScriptLoading = new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = 'https://js.paystack.co/v1/inline.js';
        s.async = true;
        s.onload = ()=> resolve('loaded');
        s.onerror = ()=> reject(new Error('Failed to load Paystack'));
        document.body.appendChild(s);
      });
      return __paystackScriptLoading;
    }

    // ===== HEADER =====
    const Header = () => (
      <header className="sticky top-0 z-40 backdrop-blur bg-white/70 border-b border-zinc-200">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-[var(--brand-accent)]/10 grid place-items-center overflow-hidden">
              <img src="https://res.cloudinary.com/dvl40rhin/image/upload/v1759081580/MARE_LOGO_ONLY_sjojzh.png" alt="Mare's Cakes & Pastries logo" className="w-9 h-9 object-contain"/>
            </div>
            <div className="leading-tight">
              <div className="text-xl font-bold" style={{color:BRAND.color}}>{BRAND.name}</div>
              <div className="text-xs text-zinc-500">Each bite will make you say MARE-Y me.</div>
            </div>
          </div>
          <a href="#order" className="hidden md:inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white" style={{backgroundColor:BRAND.color}}>Order Now</a>
        </div>
      </header>
    );

    // ===== PRIVACY =====
    function PrivacyContent(){
      return (
        <div>
          <h1 className="text-2xl font-bold mb-4">Privacy Policy</h1>
          <p className="mb-3">We collect and process your <strong>personal data</strong> (name, phone, email, gender, and delivery address) solely to:</p>
          <ul className="list-disc pl-6 space-y-1 mb-4">
            <li>Fulfil and support your order (invoicing, delivery, customer support).</li>
            <li>Run basic, privacy-aware <strong>analytics</strong> to improve our products and service.</li>
          </ul>
          <p className="mb-3">We do <strong>not</strong> sell or share your personal data with third parties for marketing. Data may be retained as required by law and accounting rules.</p>
          <p className="text-sm text-zinc-500">By placing an order, you consent to the processing of your personal data as described here.</p>
        </div>
      );
    }

    function PrivacyModal({ open, onClose }){
      React.useEffect(()=>{
        if (!open) return;
        const onKey = (e)=>{ if (e.key === 'Escape') onClose(); };
        document.addEventListener('keydown', onKey);
        return ()=> document.removeEventListener('keydown', onKey);
      }, [open, onClose]);
      if (!open) return null;
      return (
        <div className="fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/40" onClick={onClose}/>
          <div className="absolute inset-0 flex items-center justify-center p-4">
            <div className="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 max-h-[80vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold">Privacy Policy</h2>
                <button onClick={onClose} className="px-2 py-1 rounded hover:bg-zinc-100">✕</button>
              </div>
              <PrivacyContent/>
            </div>
          </div>
        </div>
      );
    }

    // ===== APP =====
    function App(){
      // Auto-close sheet when app/tab is backgrounded (typical after opening WA)
      useEffect(() => {
        const vis = () => {
          if (document.visibilityState === 'hidden') {
            // If the user switched away (likely to WhatsApp), close the sheet
            setPostPay(s => s.visible ? {...s, visible:false} : s);
          }
        };
        document.addEventListener('visibilitychange', vis);
        return () => document.removeEventListener('visibilitychange', vis);
      }, []);

      const { cart, setQty, setCart } = useCart();
      const [postPay, setPostPay] = useState({ visible:false, link:'', ref:'', items:[], subtotal:0, vat:0, total:0 });
      const [form, setForm] = useState({ name:"", phone:"", email:"", gender:"", delivery:"", consent:false });
      const [selectedSize, setSelectedSize] = useState({});
      const [showPrivacy, setShowPrivacy] = useState(false);
      const [isPaying, setIsPaying] = useState(false);

      const lineTotal = (e)=> (e.price||0)*(e.qty||0);
      const subtotal = useMemo(()=> Object.values(cart).reduce((s, e)=> s + lineTotal(e), 0), [cart]);
      const vat = useMemo(()=> subtotal * VAT_RATE, [subtotal]);
      const grandTotal = useMemo(()=> subtotal + vat, [subtotal, vat]);

      // Mini-only rule: if ONLY minis are in cart, need >= 4 combined
      const totalMiniQty = useMemo(() => Object.entries(cart)
        .reduce((sum, [key, it]) => key.endsWith('__Mini') ? sum + (it.qty||0) : sum, 0), [cart]);
      const hasNonMini = useMemo(() => Object.keys(cart).some(k => !k.endsWith('__Mini')), [cart]);
      const miniOnlyAndInsufficient = totalMiniQty > 0 && !hasNonMini && totalMiniQty < 4;

      const getDefaultSize = (item)=> SIZES.find(sz => item.variants[sz]);
      const getActiveSize = (item)=> selectedSize[item.id] || getDefaultSize(item);
      const getPrice = (item, sz)=> item.variants[sz] || 0;
      const cartKey = (item, sz)=> `${item.id}__${sz}`;
      const cartName = (item, sz)=> `${item.name} (${sz})`;

      // WhatsApp text
      const makeWhatsAppText = (paymentRef) => {
        const lines = [
          `*New Order — ${BRAND.name}*`,
          `Name: ${form.name}`,
          `Phone: ${form.phone}`,
          form.email ? `Email: ${form.email}` : null,
          form.gender ? `Gender: ${form.gender}` : null,
          form.delivery ? `Delivery Location: ${form.delivery}` : null,
          '', '*Items*',
          ...Object.entries(cart).map(([key, it])=>`- ${it.name} x${it.qty} = ${N(lineTotal(it))}`),
          '', `*Subtotal:* ${N(subtotal)}`,
          `*VAT (7.5%):* ${N(vat)}`,
          `*Total:* ${N(grandTotal)}`,
          paymentRef ? `Payment Ref: ${paymentRef}` : null
        ].filter(Boolean);
        return encodeURIComponent(lines.join("\n"));
      };

      // Prefer a WhatsApp URL that works on Safari/iOS too
      function buildWhatsAppLink(paymentRef){
        const text = makeWhatsAppText(paymentRef);
        const phone = BUSINESS.whatsappPhone;
        // api.whatsapp.com is the most reliable across Safari, iOS and desktop
        return `https://api.whatsapp.com/send?phone=${phone}&text=${text}`;
      }

      // Send to Google Sheet webhook
      async function sendOrderToWebhook(payload){
        try{
          if(!WEBHOOK_URL) return;
          if (navigator.sendBeacon) {
            const blob = new Blob([JSON.stringify(payload)], { type: 'text/plain;charset=utf-8' });
            navigator.sendBeacon(WEBHOOK_URL, blob);
          } else {
            await fetch(WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload), mode:'no-cors', keepalive:true });
          }
        }catch(err){ console.warn('Webhook failed:', err); }
      }

      async function handlePaystack(){
        if (isPaying) return;
        if (!form.consent) return alert('Please consent to the Privacy Policy before paying.');
        if (!form.name || !form.phone || !form.email || !form.gender || !form.delivery) return alert('Please fill Name, Phone, Email, Gender, Delivery.');
        if (grandTotal <= 0) return alert('Your cart is empty.');
        if (miniOnlyAndInsufficient) return alert('Minimum order for Minis is 4. Please add at least 4 Minis (any flavours).');
        try{
          setIsPaying(true);
          // OPEN A POPUP *SYNCED WITH USER GESTURE* (Safari allows this)
          let waWindow = null;
          try { waWindow = window.open('about:blank', '_blank'); } catch(_) { waWindow = null; }

          const state = await ensurePaystack().then(r=>({ ok:true, r })).catch(e=>({ ok:false, e }));
          if (!state.ok || !window.PaystackPop || typeof window.PaystackPop.setup !== 'function') {
            setIsPaying(false);
            console.error('Paystack not available', state);
            return alert('Paystack couldn\'t load. Check your connection and try again.');
          }
          const amountKobo = Math.round(grandTotal * 100);
          let handler;
          try {
            handler = window.PaystackPop.setup({
              key: PAYMENT.paystackPublicKey,
              email: form.email,
              amount: amountKobo,
              currency: 'NGN',
              metadata: { custom_fields: [
                { display_name: 'Customer', variable_name: 'customer_name', value: form.name },
                { display_name: 'Phone', variable_name: 'phone', value: form.phone },
                { display_name: 'Gender', variable_name: 'gender', value: form.gender },
                { display_name: 'Delivery', variable_name: 'delivery_location', value: form.delivery }
              ]},
              callback: (response) => {
                try {
                  const paymentRef = response && response.reference ? response.reference : '';
                  const items = Object.entries(cart).map(([key, it])=>({ name: it.name, qty: it.qty, unit_price: it.price, line_total: (it.price||0)*(it.qty||0) }));
                  const payload = {
                    provider: 'paystack',
                    payment_ref: paymentRef,
                    currency: 'NGN',
                    totals: { subtotal: subtotal, vat: vat, total: grandTotal },
                    customer: { name: form.name, phone: form.phone, email: form.email, gender: form.gender, delivery: form.delivery, consent: true },
                    items,
                    business: { name: BRAND.name },
                    created_at: new Date().toISOString()
                  };
                  sendOrderToWebhook(payload);

                  const link = buildWhatsAppLink(paymentRef);
                  // Always show the fallback WhatsApp button for ALL browsers/devices
                  setPostPay({ visible:true, link, ref: paymentRef, items, subtotal, vat, total: grandTotal });
                  // If we have a pre-opened window, also try to redirect it (best effort)
                  if (waWindow && !waWindow.closed) {
                    try { waWindow.location = link; }
                    catch(_) { try { window.open(link, '_blank'); } catch{} }
                  }
                } catch(err) {
                  console.error('Callback error:', err);
                  alert('Payment succeeded but we had trouble preparing your WhatsApp order link. Please contact us.');
                } finally {
                  setIsPaying(false);
                }
              },
              onClose: function(){
                // If user cancelled, close the pre-opened blank if it exists
                try { if (waWindow && !waWindow.closed) waWindow.close(); } catch{}
                setIsPaying(false);
              }
            });
          } catch(setupErr){
            setIsPaying(false);
            console.error('Paystack setup error', setupErr);
            return alert('Could not start Paystack. Please refresh and try again.');
          }
          try { handler.openIframe(); } catch(openErr){ setIsPaying(false); console.error('openIframe failed', openErr); alert('Could not open Paystack window. Try again.'); }
        }catch(e){ setIsPaying(false); console.error('handlePaystack failed', e); alert('Unexpected error. Please try again.'); }
      }

      const SizePills = ({ item, totalMiniQty, hasNonMini }) => {
        const active = getActiveSize(item);
        const showBadge = item.variants.Mini;
        const badgeOk = hasNonMini || totalMiniQty >= 4;
        return (
          <div className="flex items-center gap-2">
            <div className="flex gap-1.5">
              {SIZES.map(sz=>{
                const available = !!item.variants[sz];
                const isActive = active === sz;
                return (
                  <button key={sz}
                    className={`px-2.5 py-1 rounded-lg text-xs border ${isActive? 'border-zinc-900 font-semibold' : 'border-zinc-300'} ${available? '' : 'opacity-40 cursor-not-allowed'}`}
                    onClick={()=> available && setSelectedSize(s=>({...s, [item.id]: sz}))}
                    disabled={!available}
                  >{sz}</button>
                );
              })}
            </div>
            {showBadge && (
              <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] leading-none border ${badgeOk ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : 'bg-red-50 text-red-700 border-red-200'}`}>
                Minis: {Math.min(totalMiniQty,4)}/4
              </span>
            )}
          </div>
        );
      };

      const QtyForItem = ({ item }) => {
        const sz = getActiveSize(item);
        const key = cartKey(item, sz);
        const price = getPrice(item, sz);
        const qty = cart[key]?.qty || 0;
        return (
          <div className="flex items-center gap-3">
            <div className="w-24 text-right font-semibold">{N(price)}</div>
            <Qty value={qty} onChange={(q)=>{
              const entry = q > 0 ? { name: cartName(item, sz), price, qty:q } : null;
              setQty(key, entry);
            }}/>
          </div>
        );
      };

      // Sticky mobile pay bar so the button is always visible
      const mobileDisabled = !form.consent || !form.name || !form.phone || !form.email || !form.gender || !form.delivery || grandTotal<=0 || isPaying || miniOnlyAndInsufficient;

      return (
        <div className="min-h-screen">
          <Header/>
          <main id="order" className="max-w-6xl mx-auto px-4 pb-28 md:pb-20 grid lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
              <Section title="Menu" right={<span className="text-xs text-zinc-500">Choose size then set qty</span>}>
                <div className="divide-y">
                  {ITEMS.map((it)=> (
                    <div key={it.id} className="py-4 flex items-center gap-4">
                      <div className="w-20 h-20 flex-shrink-0 rounded-xl border border-zinc-200 overflow-hidden bg-zinc-100">
                        {it.img ? <img src={it.img} alt={it.name} className="w-full h-full object-cover"/> : <div className="w-full h-full grid place-items-center text-xs text-zinc-400">No Image</div>}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="font-medium">{it.name}</div>
                        <div className="text-xs text-zinc-500 mb-1">{it.group}</div>
                        <SizePills item={it} totalMiniQty={totalMiniQty} hasNonMini={hasNonMini} />
                      </div>
                      <QtyForItem item={it} />
                    </div>
                  ))}
                </div>
              </Section>

              <Section title="Customer">
                <div className="grid md:grid-cols-3 gap-4">
                  <div>
                    <label className="text-sm text-zinc-600">Full Name</label>
                    <input className="w-full rounded-xl border border-zinc-300 px-3 py-2" value={form.name} onChange={e=>setForm({...form, name:e.target.value})}/>
                  </div>
                  <div>
                    <label className="text-sm text-zinc-600">Phone</label>
                    <input className="w-full rounded-xl border border-zinc-300 px-3 py-2" value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})}/>
                  </div>
                  <div>
                    <label className="text-sm text-zinc-600">Email</label>
                    <input type="email" className="w-full rounded-xl border border-zinc-300 px-3 py-2" value={form.email} onChange={e=>setForm({...form, email:e.target.value})}/>
                  </div>
                  <div>
                    <label className="text-sm text-zinc-600">Gender</label>
                    <select className="w-full rounded-xl border border-zinc-300 px-3 py-2 bg-white" value={form.gender} onChange={e=>setForm({...form, gender:e.target.value})}>
                      <option value="">Select gender</option>
                      <option>Female</option>
                      <option>Male</option>
                      <option>Prefer not to say</option>
                    </select>
                  </div>
                  <div className="md:col-span-2">
                    <label className="text-sm text-zinc-600">Delivery Location / Address</label>
                    <input className="w-full rounded-xl border border-zinc-300 px-3 py-2" placeholder="e.g., Yaba, Lagos — 24 Ajose Street" value={form.delivery} onChange={e=>setForm({...form, delivery:e.target.value})}/>
                  </div>
                  <div className="md:col-span-3">
                    <label className="inline-flex items-start gap-2 text-sm">
                      <input type="checkbox" className="mt-1" checked={form.consent} onChange={e=>setForm({...form, consent:e.target.checked})}/>
                      <span>I consent to the <button type="button" className="text-blue-600 underline" onClick={()=>setShowPrivacy(true)}>Privacy Policy</button> and agree my personal data will be used for <strong>order fulfilment</strong> and <strong>analytics only</strong>.</span>
                    </label>
                  </div>
                </div>
              </Section>
            </div>

            <div className="lg:col-span-1 space-y-6">
              <Section title="Summary" right={<span className="text-xs text-zinc-500">VAT 7.5%</span>}>
                <div className="space-y-2 text-sm">
                  <div className="flex items-center justify-between"><span>Subtotal</span><span>{N(subtotal||0)}</span></div>
                  <div className="flex items-center justify-between"><span>VAT (7.5%)</span><span>{N(vat||0)}</span></div>
                  <hr className="my-1"/>
                  <div className="flex items-center justify-between font-semibold text-lg"><span>Total</span><span>{N(grandTotal||0)}</span></div>
                  <div className="space-y-2 pt-2">
                    <button onClick={handlePaystack} className="w-full py-3 rounded-2xl text-white font-semibold disabled:opacity-50" style={{backgroundColor:'var(--brand-primary)'}} disabled={mobileDisabled}>
                      {isPaying ? 'Opening Paystack…' : 'Pay with Paystack'}
                    </button>
                    <p className="text-xs text-zinc-500">After payment, a WhatsApp link will open with your order summary.</p>
                    <p className="text-xs text-red-600">Minimum order for <strong>Mini</strong> sizes is <strong>4</strong> if ordering minis only.</p>
                    {!hasNonMini && totalMiniQty>0 && totalMiniQty<4 && (
                      <p className="text-xs text-red-600">You currently have {totalMiniQty} Mini item(s). Add {4-totalMiniQty} more Mini to proceed.</p>
                    )}
                  </div>
                </div>
              </Section>
            </div>
          </main>

          {/* Sticky mobile bar */}
          <div className="fixed md:hidden bottom-0 inset-x-0 z-50 bg-white/95 backdrop-blur border-t border-zinc-200 p-3 flex items-center gap-3">
            <div className="flex-1">
              <div className="text-xs text-zinc-500">Total (incl. VAT)</div>
              <div className="font-semibold">{N(grandTotal||0)}</div>
            </div>
            <button onClick={handlePaystack} className="px-4 py-2 rounded-xl text-white font-semibold disabled:opacity-50" style={{backgroundColor:'var(--brand-primary)'}} disabled={mobileDisabled}>
              {isPaying ? 'Opening…' : 'Pay'}
            </button>
          </div>

          <PrivacyModal open={showPrivacy} onClose={()=>setShowPrivacy(false)} />

          {postPay.visible && (
            <div className="fixed inset-0 z-50">
              <div className="absolute inset-0 bg-black/40" onClick={()=>setPostPay(s=>({...s, visible:false}))}></div>
              <div className="absolute inset-x-0 bottom-0">
                <div className="bg-white rounded-t-2xl shadow-2xl p-5 max-h-[75vh] overflow-y-auto">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="text-lg font-semibold">Order Ready to Send</h3>
                    <button className="px-2 py-1 rounded hover:bg-zinc-100" onClick={()=>setPostPay(s=>({...s, visible:false}))}>✕</button>
                  </div>
                  <p className="text-sm text-zinc-600 mb-3">Tap the button below to send your order to WhatsApp. If a tab already opened, this is a backup.</p>
                  <div className="bg-zinc-50 border border-zinc-200 rounded-xl p-3 mb-3">
                    <div className="text-sm font-medium mb-2">Items</div>
                    <ul className="text-sm space-y-1">
                      {postPay.items.map((it,idx)=> (
                        <li key={idx} className="flex justify-between">
                          <span>{it.name} ×{it.qty}</span>
                          <span>₦{((it.line_total)||0).toLocaleString('en-NG')}</span>
                        </li>
                      ))}
                    </ul>
                    <hr className="my-2"/>
                    <div className="text-sm space-y-1">
                      <div className="flex justify-between"><span>Subtotal</span><span>₦{(postPay.subtotal||0).toLocaleString('en-NG')}</span></div>
                      <div className="flex justify-between"><span>VAT (7.5%)</span><span>₦{(postPay.vat||0).toLocaleString('en-NG')}</span></div>
                      <div className="flex justify-between font-semibold"><span>Total</span><span>₦{(postPay.total||0).toLocaleString('en-NG')}</span></div>
                    </div>
                    {postPay.ref && (
                      <div className="text-[11px] text-zinc-500 mt-2">Payment Ref: {postPay.ref}</div>
                    )}
                  </div>
                  <a href={postPay.link} target="_blank" rel="noopener" className="block w-full text-center py-3 rounded-2xl text-white font-semibold" style={{backgroundColor:'var(--brand-primary)'}}
                  onClick={() => {
                    // Give the new tab a moment to spawn, then close the sheet
                    setTimeout(() => setPostPay(s=>({...s, visible:false})), 600);
                  }}>
                    Open WhatsApp & Send Order
                  </a>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ===== MOUNT SAFELY =====
    function mountApp(){
      if (!window.React || !window.ReactDOM) return setTimeout(mountApp, 30);
      const el = document.getElementById('root');
      if (!el) return setTimeout(mountApp, 30);
      ReactDOM.createRoot(el).render(<App/>);
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', mountApp); else mountApp();

    // ===== ERROR & LOAD DIAGNOSTICS =====
    (function diagnostics(){
      const log = (...a)=>{ if (DEBUG) console.log('[diag]', ...a); };
      log('React?', !!window.React, 'ReactDOM?', !!window.ReactDOM);
      window.addEventListener('error', function(e){ console.warn('[window.onerror]', e.message, e.filename, e.lineno); });
      window.addEventListener('unhandledrejection', function(e){ console.warn('[unhandledrejection]', e.reason); });
    })();

    // ===== LIGHT TESTS =====
    (function runTests(){
      function assert(name, cond){ if(!cond){ console.error('TEST FAIL:', name); } else { console.log('TEST PASS:', name); } }
      // VAT 7.5% exact
      (function(){ const sub=1000; const vat=sub*0.075; const total=sub+vat; assert('VAT calc 1000->75', vat===75); assert('Total 1000->1075', total===1075); })();
      // N formatting
      (function(){ assert('N(12345) formats', N(12345)==='₦12,345'); })();
      // Mini-only rule
      (function(){
        const cart={ 'a__Mini':{qty:3,price:1000,name:'A (Mini)' } }; const totalMini = Object.entries(cart).reduce((s,[k,v])=>k.endsWith('__Mini')?s+v.qty:s,0); const hasNonMini=false; assert('Mini-only insufficient (<4)', totalMini>0 && !hasNonMini && totalMini<4 );
        const cart2={ 'a__Mini':{qty:4,price:1000,name:'A (Mini)' } }; const tm2=Object.entries(cart2).reduce((s,[k,v])=>k.endsWith('__Mini')?s+v.qty:s,0); assert('Mini-only OK (=4)', tm2>=4);
        const cart3={ 'a__Mini':{qty:1,price:1000,name:'A (Mini)' }, 'b__Regular':{qty:1,price:2000,name:'B (Regular)'} }; const tm3=Object.entries(cart3).reduce((s,[k,v])=>k.endsWith('__Mini')?s+v.qty:s,0); const hn3=Object.keys(cart3).some(k=>!k.endsWith('__Mini')); assert('Has non-mini bypass', hn3 && tm3===1);
      })();
      // WhatsApp link correctness & encoding
      (function(){
        const txt = encodeURIComponent('hello world!\nline2');
        const phone='2349065307788';
        const url = `https://api.whatsapp.com/send?phone=${phone}&text=${txt}`;
        const ok = /api\.whatsapp\.com\/send\?phone=/.test(url) && /text=/.test(url);
        assert('WA URL uses api.whatsapp.com + has text', ok);
      })();
      // ensurePaystack returns a Promise
      (function(){
        const p = ensurePaystack();
        const isPromise = !!p && typeof p.then==='function';
        assert('ensurePaystack returns Promise', isPromise);
      })();
      // Visibility listener attachable
      (function(){
        const handlerExists = typeof document.addEventListener === 'function';
        assert('Visibility listener attachable', handlerExists);
      })();
      // Cart math sample
      (function(){
        const e1={price:1000, qty:2}; const e2={price:500, qty:1};
        const sub=(e1.price*e1.qty)+(e2.price*e2.qty); const v=sub*0.075; const t=sub+v;
        assert('Cart sample subtotal', sub===2500);
        assert('Cart sample VAT', Math.abs(v-187.5)<1e-9);
        assert('Cart sample total', Math.abs(t-2687.5)<1e-9);
      })();
    })();
  </script>
</body>
</html>
